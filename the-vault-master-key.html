<!DOCTYPE html>
<html>
<head>
    <title>The Keeper's Ledger</title>
    <style>
        body { background: #0d1117; color: white; font-family: sans-serif; padding: 50px; }
        .admin-box { background: #161b22; border: 1px solid #D4AF37; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; background: #0d1117; color: #D4AF37; border: 1px solid #30363d; padding: 10px; box-sizing: border-box; font-family: monospace; }
        input { background: #0d1117; color: white; border: 1px solid #30363d; padding: 10px; margin-bottom: 10px; width: 250px; border-radius: 5px; }
        button { background: #D4AF37; color: black; padding: 12px 24px; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .warning { color: #ff6b6b; font-size: 12px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; color: #8b949e; font-size: 0.9em; }
        .ban-hammer { border-color: #ff4d4d; }
        hr { border: 0; border-top: 1px solid #30363d; margin: 25px 0; }
        .heinous { background: #4a0000 !important; border: 2px solid #ff4d4d !important; animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.7; } }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #30363d; }
    </style>
</head>
<body>
    <h1>The Keeper's Ledger</h1>

    <div class="admin-box" id="login-section">
        <h3>Identify Yourself</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <br><br>
        <button id="loginBtn">Login to the Vault</button>
    </div>

    <div class="admin-box" id="ledger-section" style="display:none;">
        <p class="warning" style="color:#4CAF50">‚úÖ ACCESS GRANTED. You are the Keeper.</p>
        
        <label>1. Paste Block IDs (separated by commas):</label>
        <textarea id="blockIds" placeholder="417, 418, 419..."></textarea>
        
        <label>2. Attach Buyer Email (Required for Paid Blocks):</label>
        <input type="email" id="buyerEmail" placeholder="client@gmail.com" style="width: 100%; box-sizing: border-box; border-color: #D4AF37;">

        <br><br>

        <button id="batchUpdateBtn">Mark as PAID & Assign Email</button>
        
        <hr>

        <button id="wfcUpdateBtn" style="background: #6a0dad; color: white; margin-right: 10px;">
            Purple Rain: Mark as WFC Available
        </button>
        
        <button id="availableBtn" style="background: #30363d; color: white;">
            üöÆ Scrub & Release (Mark as Available)
        </button>

        <div class="admin-box ban-hammer" style="margin-top: 30px;">
            <h3 style="color: #ff4d4d;">üö´ The Ban Hammer</h3>
            <label>Paste Emails to Banish (separated by commas):</label>
            <textarea id="banEmails" placeholder="weirdo1@gmail.com, spammer2@yahoo.com..."></textarea>
            <label>Reason for Banishment:</label>
            <input type="text" id="banReason" placeholder="e.g. Hate speech, T&C violation" style="width: 100%; box-sizing: border-box;">
            <br><br>
            <button id="batchBanBtn" style="background: #ff4d4d; color: white;">EXECUTE BANISHMENT</button>
        </div>

        <div class="admin-box" style="border-color: #4CAF50; margin-top: 30px;">
            <h3 style="color: #4CAF50;">üîç The Deep Investigator</h3>
            <label>Search Private Claims by Email:</label>
            <input type="email" id="investigateEmail" placeholder="weirdo@gmail.com" style="width: 70%;">
            <button id="searchOwnerBtn" style="background: #4CAF50; color: white;">Scan Archives</button>
            <div id="investigationResults" style="margin-top: 15px; color: #D4AF37; font-family: monospace; line-height: 1.6;"></div>
        </div>

        <div class="admin-box" style="border-color: #D4AF37;">
            <h3>üö© Pending Reports</h3>
            <button id="loadReportsBtn">Check for New Flags</button>
            <div id="reportsList" style="margin-top: 15px; font-size: 0.9em;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, 
            writeBatch, 
            doc, 
            getDoc,
            serverTimestamp, 
            collection, 
            query, 
            where, 
            updateDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDo9YzptBrAvJy7hjiGh1YSy20lZzOKVZc",
            authDomain: "vault-of-time-e6c03.firebaseapp.com",
            projectId: "vault-of-time-e6c03",
            storageBucket: "vault-of-time-e6c03.firebasestorage.app",
            messagingSenderId: "941244238426",
            appId: "1:941244238426:web:80f80b5237b84b1740e663"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.getElementById('loginBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('ledger-section').style.display = 'block';
            } catch (error) {
                alert("Access Denied: " + error.message);
            }
        };

        document.getElementById('batchUpdateBtn').onclick = async () => {
            const input = document.getElementById('blockIds').value;
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const blockArray = input.split(',').map(id => id.trim()).filter(id => id !== "");
            if (blockArray.length === 0 || !buyerEmail) return alert("IDs and Email required!");

            const batch = writeBatch(db);
            blockArray.forEach((id) => {
                batch.set(doc(db, "blocks", id), { status: "paid", purchasedAt: serverTimestamp(), reserved: false }, { merge: true });
                batch.set(doc(db, "claims", id), { email: buyerEmail, blockId: id, createdAt: serverTimestamp() });
            });
            await batch.commit();
            alert("‚úÖ Blocks updated!");
        };

      // üöÆ SCRUB & RELEASE (Mark as Available)
        document.getElementById('availableBtn').onclick = async () => {
            const input = document.getElementById('blockIds').value;
            // 1. Clean the input
            const blockArray = input.split(',').map(id => id.trim()).filter(id => id !== "");
            
            if (blockArray.length === 0) {
                return alert("‚ö†Ô∏è Please enter Block IDs to scrub.");
            }

            if (!confirm(`‚ö†Ô∏è NUCLEAR OPTION: DELETE ${blockArray.length} BLOCKS?\n\nThis will completely remove them from the database.\nThey will reset to 'Factory Settings' (Available).`)) {
                return;
            }

            const batch = writeBatch(db);

            blockArray.forEach((id) => {
                // 2. THE NUCLEAR FIX: Delete the document entirely.
                // Instead of updating status to 'available', we just remove the block.
                // If it doesn't exist, the Main Grid treats it as free.
                const blockRef = doc(db, "blocks", id);
                batch.delete(blockRef);
                
                // 3. Delete the Claim record too (if it exists)
                const claimRef = doc(db, "claims", id);
                batch.delete(claimRef);
            });

            try {
                await batch.commit();
                alert(`‚úÖ Successfully DELETED ${blockArray.length} blocks.\n\nüëâ IMPORTANT: Refresh your Main Grid page to see the changes.`);
                document.getElementById('blockIds').value = ""; 
            } catch (err) {
                console.error("Scrub failed:", err);
                alert("‚ùå Error scrubbing blocks: " + err.message);
            }
        };
        document.getElementById('batchBanBtn').onclick = async () => {
            const emails = document.getElementById('banEmails').value.split(',').map(e => e.trim().toLowerCase()).filter(e => e !== "");
            if (emails.length === 0) return alert("Emails required!");
            const batch = writeBatch(db);
            emails.forEach(email => batch.set(doc(db, "banned_users", email), { bannedAt: serverTimestamp(), reason: document.getElementById('banReason').value || "Admin Banishment" }));
            await batch.commit();
            alert("üö´ Users Banished!");
        };

        document.getElementById('searchOwnerBtn').onclick = async () => {
            const email = document.getElementById('investigateEmail').value.trim().toLowerCase();
            const q = query(collection(db, "claims"), where("email", "==", email));
            const snap = await getDocs(q);
            let blocks = [];
            snap.forEach(doc => blocks.push(doc.id));
            document.getElementById('investigationResults').innerHTML = blocks.length > 0 ? `‚ö†Ô∏è Found: ${blocks.join(', ')}` : "No records.";
            if(blocks.length > 0) document.getElementById('blockIds').value = blocks.join(', ');
        };

        document.getElementById('loadReportsBtn').onclick = async () => {
            const reportsDiv = document.getElementById('reportsList');
            reportsDiv.innerHTML = "‚è≥ Fetching flags...";
            const snap = await getDocs(query(collection(db, "reports"), where("status", "==", "pending_review")));
            if (snap.empty) return reportsDiv.innerHTML = "‚úÖ Vault is quiet.";

            const counts = {};
            snap.forEach(d => counts[d.data().blockId] = (counts[d.data().blockId] || 0) + 1);

            let html = '<table><tr><th>Block</th><th>Reason</th><th>Actions</th></tr>';
            snap.forEach((report) => {
                const data = report.data();
                const heinous = counts[data.blockId] >= 3;
                html += `<tr class="${heinous ? 'heinous' : ''}">
                    <td>#${data.blockId} ${heinous ? 'üö®' : ''}</td>
                    <td>${data.reason}</td>
                    <td>
                        <button onclick="window.investigateReport('${data.blockId}')">üîç Scan</button>
                        <button onclick="window.resolveReport('${report.id}')" style="background:#4CAF50; color:white;">‚úÖ Clear</button>
                        <button onclick="window.banAndScrub('${data.blockId}', '${report.id}')" style="background:#8b0000; color:white;">üî• BAN & SCRUB</button>
                    </td>
                </tr>`;
            });
            reportsDiv.innerHTML = html + '</table>';
        };

        window.investigateReport = (id) => { document.getElementById('investigateEmail').scrollIntoView(); alert(`Scanning Block #${id}`); };

        window.resolveReport = async (id) => {
            const note = prompt("Resolution note?");
            if (!note) return;
            await updateDoc(doc(db, "reports", id), { status: note, resolvedAt: serverTimestamp() });
            document.getElementById('loadReportsBtn').click();
        };

        window.banAndScrub = async (blockId, reportId) => {
            if (!confirm(`Permanently ban owner of #${blockId} and wipe content?`)) return;
            try {
                const claimSnap = await getDoc(doc(db, "claims", blockId));
                if (!claimSnap.exists()) return alert("Owner email not found in archives.");
                const email = claimSnap.data().email;

                const batch = writeBatch(db);
                batch.set(doc(db, "banned_users", email.toLowerCase()), { bannedAt: serverTimestamp(), reason: "Heinous Content" });
                batch.update(doc(db, "blocks", blockId), { status: "available", message: null, mediaUrl: null, ownerId: null });
                batch.update(doc(db, "reports", reportId), { status: "BANISHED", resolvedAt: serverTimestamp() });
                
                await batch.commit();
                alert("üî• Banished and Scrubbed.");
                document.getElementById('loadReportsBtn').click();
            } catch (e) { alert("Error: " + e.message); }
        };
    </script>
</body>
</html>
