
<!DOCTYPE html>
<html>
<head>
    <title>The Keeper's Ledger</title>
    <style>
        body { background: #0d1117; color: white; font-family: sans-serif; padding: 50px; }
        .admin-box { background: #161b22; border: 1px solid #D4AF37; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; background: #0d1117; color: #D4AF37; border: 1px solid #30363d; padding: 10px; box-sizing: border-box; font-family: monospace; }
        input { background: #0d1117; color: white; border: 1px solid #30363d; padding: 10px; margin-bottom: 10px; width: 250px; border-radius: 5px; }
        button { background: #D4AF37; color: black; padding: 12px 24px; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .warning { color: #ff6b6b; font-size: 12px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; color: #8b949e; font-size: 0.9em; }
        .ban-hammer { border-color: #ff4d4d; }
    </style>
</head>
<body>
    <h1>The Keeper's Ledger</h1>

    <div class="admin-box" id="login-section">
        <h3>Identify Yourself</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password"><br>
        <button id="loginBtn">Login to the Vault</button>
    </div>

    <div class="admin-box" id="ledger-section" style="display:none;">
        <p class="warning" style="color:#4CAF50">âœ… ACCESS GRANTED. You are the Keeper.</p>
        
        <label>1. Paste Block IDs (separated by commas):</label>
        <textarea id="blockIds" placeholder="417, 418, 419..."></textarea>
        
        <label>2. Attach Buyer Email (Required for Paid Blocks):</label>
        <input type="email" id="buyerEmail" placeholder="client@gmail.com" style="width: 100%; box-sizing: border-box; border-color: #D4AF37;">

        <br><br>
        <button id="batchUpdateBtn">Mark as PAID & Assign Email</button>
        
        <hr style="border-color: #30363d; margin: 20px 0;">

        <button id="wfcUpdateBtn" style="background: #6a0dad; color: white; margin-right: 10px;">
            Purple Rain: Mark as WFC Available
        </button>
        <button id="availableBtn" style="background: #30363d; color: white;">
            ðŸš® Scrub & Release (Mark as Available)
        </button>

        <div class="admin-box ban-hammer" style="margin-top: 30px;">
            <h3 style="color: #ff4d4d;">ðŸš« The Ban Hammer</h3>
            <label>Paste Emails to Banish (separated by commas):</label>
            <textarea id="banEmails" placeholder="weirdo1@gmail.com, spammer2@yahoo.com..."></textarea>
            <label>Reason for Banishment:</label>
            <input type="text" id="banReason" placeholder="e.g. Hate speech, T&C violation" style="width: 100%; box-sizing: border-box;">
            <br><br>
            <button id="batchBanBtn" style="background: #ff4d4d; color: white;">EXECUTE BANISHMENT</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, writeBatch, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDo9YzptBrAvJy7hjiGh1YSy20lZzOKVZc",
            authDomain: "vault-of-time-e6c03.firebaseapp.com",
            projectId: "vault-of-time-e6c03",
            storageBucket: "vault-of-time-e6c03.firebasestorage.app",
            messagingSenderId: "941244238426",
            appId: "1:941244238426:web:80f80b5237b84b1740e663"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LOGIN ACTION ---
        document.getElementById('loginBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('ledger-section').style.display = 'block';
            } catch (error) {
                console.error(error);
                alert("Access Denied: " + error.message);
            }
        };

        // --- BATCH UPDATE ACTION ---
        document.getElementById('batchUpdateBtn').onclick = async () => {
            const input = document.getElementById('blockIds').value;
            const buyerEmail = document.getElementById('buyerEmail').value.trim();
            const blockArray = input.split(',').map(id => id.trim()).filter(id => id !== "");
            
            if (blockArray.length === 0) return alert("No IDs to process!");
            if (!buyerEmail) return alert("âš ï¸ STOP: Enter Buyer Email!");

            const batch = writeBatch(db);
            blockArray.forEach((id) => {
                const blockRef = doc(db, "blocks", id); 
                const claimRef = doc(db, "claims", id); 

                batch.set(blockRef, { 
                    status: "paid", 
                    ownerId: null, 
                    email: null,   
                    purchasedAt: serverTimestamp(),
                    reserved: false,
                    reservedBy: null,
                    reservedAt: null
                }, { merge: true });

                batch.set(claimRef, {
                    email: buyerEmail,
                    blockId: id,
                    createdAt: serverTimestamp()
                });
            });

            try {
                await batch.commit();
                alert(`âœ… SUCCESS! ${blockArray.length} blocks processed.`);
                document.getElementById('blockIds').value = "";
                document.getElementById('buyerEmail').value = "";
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        // --- ðŸ”¨ BATCH BANISHMENT ACTION ---
        document.getElementById('batchBanBtn').onclick = async () => {
            const emailInput = document.getElementById('banEmails').value;
            const reason = document.getElementById('banReason').value.trim() || "Admin Banishment";
            const emailArray = emailInput.split(',').map(e => e.trim().toLowerCase()).filter(e => e !== "");

            if (emailArray.length === 0) return alert("The hammer needs targets! Paste some emails.");

            const confirmBan = confirm(`âš ï¸ DANGER: You are about to banish ${emailArray.length} email(s) permanently. Proceed?`);
            if (!confirmBan) return;

            const batch = writeBatch(db);
            emailArray.forEach((email) => {
                const banRef = doc(db, "banned_users", email);
                batch.set(banRef, {
                    bannedAt: serverTimestamp(),
                    reason: reason,
                    bannedBy: "Keeper Admin UI"
                });
            });

            try {
                await batch.commit();
                alert(`ðŸš« EXECUTED: ${emailArray.length} users have been cast out.`);
                document.getElementById('banEmails').value = "";
                document.getElementById('banReason').value = "";
            } catch (error) {
                console.error(error);
                alert("The hammer missed: " + error.message);
            }
        };

        // --- PURPLE RAIN (WFC) ---
        document.getElementById('wfcUpdateBtn').onclick = async () => {
            const input = document.getElementById('blockIds').value;
            const blockArray = input.split(',').map(id => id.trim()).filter(id => id !== "");
            if (blockArray.length === 0) return alert("No IDs to process!");

            const batch = writeBatch(db);
            blockArray.forEach((id) => {
                const blockRef = doc(db, "blocks", id); 
                batch.set(blockRef, { 
                    status: "available", 
                    partnership: "WFC",
                    reserved: false,
                    reservedBy: null,
                    mediaUrl: null, imageUrl: null, message: null
                }, { merge: true });
            });

            try {
                await batch.commit();
                alert(`Done! ${blockArray.length} blocks are now Solidarity Purple.`);
            } catch (error) {
                alert("Error: " + error.message);
            }
        };

        // --- SCRUB & RELEASE ---
        document.getElementById('availableBtn').onclick = async () => {
            const input = document.getElementById('blockIds').value;
            const blockArray = input.split(',').map(id => id.trim()).filter(id => id !== "");
            if (blockArray.length === 0) return alert("No IDs to process!");

            const batch = writeBatch(db);
            blockArray.forEach((id) => {
                const blockRef = doc(db, "blocks", id); 
                batch.set(blockRef, { 
                    status: "available",
                    blockNumber: Number(id),
                    partnership: null,
                    reserved: false,
                    reservedBy: null,
                    reservedAt: null,
                    reservedName: null,
                    mediaUrl: null, imageUrl: null, message: null, isBulk: null,
                    email: null, ownerId: null
                });
            });

            try {
                await batch.commit();
                alert(`ðŸ§¹ Cleaned & Released ${blockArray.length} blocks.`);
            } catch (error) {
                alert("Error: " + error.message);
            }
        };
    </script>
</body>
</html>
