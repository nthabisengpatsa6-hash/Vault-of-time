<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Curator's Console | Vault of Time</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --bg: #0d1117; --panel: #161b22; --border: #30363d; }
        
        body { 
            background: var(--bg); 
            color: #c9d1d9; 
            font-family: 'Poppins', sans-serif; 
            padding: 40px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--gold); margin-top: 0; }
        h1 { border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 40px; letter-spacing: 2px; }

        /* PANELS */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .full-width { grid-column: span 2; }
        
        .admin-box { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            padding: 25px; 
            border-radius: 6px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .admin-box h3 { font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; color: #fff; }

        /* FORMS */
        label { font-size: 0.75rem; text-transform: uppercase; color: #8b949e; letter-spacing: 1px; display: block; margin-bottom: 5px; margin-top: 15px; }
        input, select, textarea { 
            background: #0d1117; 
            color: #fff; 
            border: 1px solid var(--border); 
            padding: 12px; 
            width: 100%; 
            box-sizing: border-box; 
            font-family: 'Courier Prime', monospace;
            border-radius: 4px;
        }
        input:focus { border-color: var(--gold); outline: none; }

        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        /* BUTTONS */
        button { 
            background: var(--gold); 
            color: #000; 
            padding: 12px 20px; 
            border: none; 
            cursor: pointer; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            width: 100%; 
            margin-top: 20px; 
            transition: all 0.2s;
        }
        button:hover { filter: brightness(1.1); }
        button.secondary { background: #30363d; color: var(--gold); }
        button.danger { background: transparent; border: 1px solid #da3633; color: #da3633; width: auto; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--gold); border-bottom: 1px solid var(--border); padding: 10px; }
        td { border-bottom: 1px solid var(--border); padding: 10px; color: #8b949e; }
        tr:hover td { color: #fff; background: rgba(255,255,255,0.02); }

        .price-tag { color: #4CAF50; font-weight: bold; font-family: 'Courier Prime', monospace; }
        
        /* HIDDEN SECTIONS */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-section" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <h1>The Curator's Console</h1>
        <div class="admin-box">
            <input type="email" id="adminEmail" placeholder="Curator Email">
            <input type="password" id="adminPass" placeholder="Master Key" style="margin-top: 10px;">
            <button id="loginBtn">Authenticate</button>
        </div>
    </div>

    <div id="dashboard-section" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Vault Command Center</h1>
            <button id="logoutBtn" class="danger">Sever Connection</button>
        </div>

        <div class="grid-container">

<div class="admin-box" style="border: 1px solid #00bcd4;">
    <h3 style="color: #00bcd4;">‚è≥ 3. Start Countdown</h3>
    <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">Set the deadline for the current Active Block.</p>

    <div class="row">
        <div class="col">
            <label>Coordinate #</label>
            <input type="number" id="timerBlockId" placeholder="e.g. 1">
        </div>
        <div class="col">
            <label>Duration (Hours)</label>
            <input type="number" id="timerHours" placeholder="24">
        </div>
    </div>

    <button id="startTimerBtn" style="background: #00bcd4; color: black;">INITIATE TIMER</button>
</div>
            
            <div class="admin-box full-width">
                <h3>üì° Incoming Signals (Inquiries)</h3>
                <button id="refreshBidsBtn" class="secondary" style="margin-top:0; margin-bottom: 15px; width: auto; font-size: 0.8rem;">Refresh Stream</button>
                <div id="inquiriesList" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #555; text-align: center;">Waiting for data...</p>
                </div>
            </div>

            <div class="admin-box">
                <h3>üîë 1. Authorize Bidder</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">Step 1: Create a login key for the user so they can access the upload suite.</p>
                
                <label>Bidder Email (Private)</label>
                <input type="email" id="authEmail" placeholder="user@example.com">
                
                <label>Bidder Name (Internal)</label>
                <input type="text" id="authName" placeholder="e.g. Nthabiseng">
                
                <div class="row">
                    <div class="col">
                        <label>Access Key</label>
                        <input type="text" id="authKey" placeholder="XXXX-XXXX">
                    </div>
                    <div class="col" style="display: flex; align-items: flex-end;">
                        <button id="genKeyBtn" class="secondary" style="margin: 0;">üé≤ Generate</button>
                    </div>
                </div>

                <button id="saveAuthBtn">Authorize Access</button>
            </div>

            <div class="admin-box" style="border: 1px solid #D4AF37;">
                <h3 style="color: #D4AF37;">üíé 2. Seal Coordinate</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 20px;">Step 2: Mark block as paid & update public ledger.</p>

                <div class="row">
                    <div class="col">
                        <label>Coordinate #</label>
                        <input type="number" id="sealId" placeholder="e.g. 1">
                    </div>
                    <div class="col">
                        <label>Sale Price ($)</label>
                        <input type="number" id="sealPrice" placeholder="15000">
                    </div>
                </div>

                <label>Owner Email (Must match Auth Email)</label>
                <input type="email" id="sealOwnerEmail" placeholder="user@example.com">

                <div class="row">
                    <div class="col">
                        <label>Public Alias (Ledger Name)</label>
                        <input type="text" id="sealPublicName" placeholder="e.g. The Lioness">
                    </div>
                    <div class="col">
                        <label>Social Link (Optional)</label>
                        <input type="text" id="sealSocial" placeholder="https://x.com/...">
                    </div>
                </div>

                <button id="sealBtn">SEAL & PUBLISH</button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, collection, getDocs, 
            query, orderBy, serverTimestamp, addDoc 
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDo9YzptBrAvJy7hjiGh1YSy20lZzOKVZc",
            authDomain: "vault-of-time-e6c03.firebaseapp.com",
            projectId: "vault-of-time-e6c03",
            storageBucket: "vault-of-time-e6c03.firebasestorage.app",
            messagingSenderId: "941244238426",
            appId: "1:941244238426:web:80f80b5237b84b1740e663"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH LOGIC ---
        const loginSection = document.getElementById('login-section');
        const dashboard = document.getElementById('dashboard-section');

        document.getElementById('loginBtn').onclick = async () => {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                loginSection.classList.add('hidden');
                dashboard.classList.remove('hidden');
                loadInquiries();
            } catch (e) { alert("Access Denied: " + e.message); }
        };

        document.getElementById('logoutBtn').onclick = () => {
            signOut(auth).then(() => location.reload());
        };

        // --- 1. LOAD INQUIRIES ---
        async function loadInquiries() {
            const list = document.getElementById('inquiriesList');
            list.innerHTML = "Scanning frequency...";
            
            try {
                const q = query(collection(db, "inquiries"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    list.innerHTML = "<p style='padding:20px; text-align:center;'>No active signals.</p>";
                    return;
                }

                let html = `<table>
                    <tr>
                        <th>#</th>
                        <th>Bidder</th>
                        <th>Offer</th>
                        <th>Email</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>`;

                snap.forEach(d => {
                    const data = d.data();
                    const bid = data.bidAmount ? `$${Number(data.bidAmount).toLocaleString()}` : "-";
                    // Create a safe onclick string
                    html += `<tr>
                        <td style="color:var(--gold);">#${data.coordinate}</td>
                        <td>${data.bidderName}</td>
                        <td class="price-tag">${bid}</td>
                        <td>${data.bidderEmail}</td>
                        <td style="font-size:0.8em; max-width:200px;">${data.message || ""}</td>
                        <td>
                            <button class="secondary" style="margin:0; padding:5px 10px; font-size:0.7rem;" 
                                onclick="window.prepAuth('${data.bidderEmail}', '${data.bidderName}')">
                                Process
                            </button>
                        </td>
                    </tr>`;
                });
                list.innerHTML = html + "</table>";

            } catch (err) {
                console.error(err);
                list.innerHTML = "Error loading data.";
            }
        }

        document.getElementById('refreshBidsBtn').onclick = loadInquiries;

        // --- HELPER: Pre-fill Auth Form ---
        window.prepAuth = (email, name) => {
            document.getElementById('authEmail').value = email;
            document.getElementById('authName').value = name;
            // Also pre-fill the Seal form
            document.getElementById('sealOwnerEmail').value = email;
            document.getElementById('sealPublicName').value = name;
            
            document.getElementById('authEmail').scrollIntoView({behavior: "smooth"});
            document.getElementById('genKeyBtn').click(); // Auto-gen key
        };

        // --- 2. GENERATE KEY ---
        document.getElementById('genKeyBtn').onclick = () => {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let result = "";
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            result += "-";
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('authKey').value = result;
        };

        document.getElementById('saveAuthBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value.trim().toLowerCase();
            const key = document.getElementById('authKey').value.trim();
            const name = document.getElementById('authName').value.trim();

            if (!email || !key) return alert("Missing credentials.");

            try {
                await setDoc(doc(db, "authorized_bidders", email), {
                    accessKey: key,
                    bidderName: name,
                    authorizedAt: serverTimestamp()
                });
                alert(`‚úÖ ACCESS GRANTED.\nUser: ${email}\nKey: ${key}\n\nSend this key to the Keeper via email.`);
            } catch (err) { alert("Error: " + err.message); }
        };

        // --- 3. SEAL COORDINATE (THE BIG ONE) ---
        document.getElementById('sealBtn').onclick = async () => {
            const id = document.getElementById('sealId').value;
            const price = Number(document.getElementById('sealPrice').value);
            const ownerEmail = document.getElementById('sealOwnerEmail').value.trim().toLowerCase();
            const publicName = document.getElementById('sealPublicName').value.trim();
            const social = document.getElementById('sealSocial').value.trim();

            if (!id || !price || !ownerEmail || !publicName) return alert("All fields (except Social) are required.");

            if (!confirm(`‚ö†Ô∏è SEALING COORDINATE #${id}\n\nPrice: $${price}\nOwner: ${ownerEmail}\nPublic Name: ${publicName}\n\nThis will lock the grid and update the public ledger. Proceed?`)) return;

            try {
                // A. Update Private Block (For Access & Lock)
                await setDoc(doc(db, "blocks", id), {
                    status: "paid",
                    ownerEmail: ownerEmail, // Key for them to upload
                    purchasePrice: price,
                    purchasedAt: serverTimestamp()
                }, { merge: true });

                // B. Add to Public Ledger (For Fame)
                // Use addDoc to create a new history entry
                await addDoc(collection(db, "ledger"), {
                    blockId: Number(id),
                    price: price,
                    keeperName: publicName, // Safe to show
                    socialLink: social,     // Safe to show
                    date: serverTimestamp()
                });

                alert(`üíé COORDINATE #${id} SEALED.\nThe Vault has been updated.`);
                
                // Clear form
                document.getElementById('sealId').value = "";
                document.getElementById('sealPrice').value = "";
                document.getElementById('sealOwnerEmail').value = "";
                document.getElementById('sealPublicName').value = "";
                document.getElementById('sealSocial').value = "";
            } catch (err) {
                console.error(err);
                alert("Sealing Failed: " + err.message);
            }
        };

// --- 4. START TIMER ---
document.getElementById('startTimerBtn').onclick = async () => {
    const id = document.getElementById('timerBlockId').value;
    const hours = Number(document.getElementById('timerHours').value);

    if (!id || !hours) return alert("Need Coordinate # and Hours.");

    // Calculate the future timestamp
    const now = new Date();
    const deadline = new Date(now.getTime() + hours * 60 * 60 * 1000);

    if (!confirm(`‚è≥ START TIMER?\n\nCoordinate #${id}\nDuration: ${hours} Hours\nEnds: ${deadline.toLocaleString()}\n\nThis will activate the live clock on the main site.`)) return;

    try {
        // We update the block document with the deadline
        await setDoc(doc(db, "blocks", id), {
            auctionEndsAt: deadline, 
            status: "active" // Explicitly mark it as active
        }, { merge: true });

        alert(`‚è≥ COUNTDOWN STARTED.\nCoordinate #${id} is live.`);
        // Clear inputs
        document.getElementById('timerBlockId').value = "";
        document.getElementById('timerHours').value = "";
    } catch (err) {
        alert("Error: " + err.message);
    }
};
        
    </script>
</body>
</html>
